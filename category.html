<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Category</title>
  <link rel="icon" href="data:,">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body {
      width:100vw; height:100vh; background:black; overflow:hidden;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center;
      /* Height-relative font size (better for constrained 9:16 containers) */
      font-size: calc(12px + 1.2vh);
    }
    .page-wrapper{
      aspect-ratio:9 / 16; width:100%; height:100vh; max-width:56.25vh;
      display:flex; flex-direction:column; background:white;
    }
    .banner-container{
      position:relative; width:100%; aspect-ratio:9 / 5; overflow:hidden;
      background: linear-gradient(45deg, #007bff, #0056b3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2rem;
      font-weight: bold;
    }
    .banner-container video{ width:100%; height:100%; object-fit:cover; display:block; background:black; }
    .back-to-menu{
      position:absolute; top:10px; left:10px; z-index:80;
      margin:0; padding:5px 10px; border:1px solid rgba(255,255,255,0.1); border-radius:13px;
      background:rgba(0,0,0,0.15); backdrop-filter:blur(8px); box-shadow:none;
      color:#fff; font-weight:600; font-size:0.9375rem; letter-spacing:0.3px; text-shadow:0 2px 8px rgba(0,0,0,0.8);
      display:flex; align-items:center; gap:5px; cursor:pointer; user-select:none;
      transition:all 0.3s ease;
    }
    .back-to-menu::before{
      content:"‚ò∞";
      font-size:0.8125rem;
      font-weight:400;
    }
    .back-to-menu:hover{
      background:rgba(0,0,0,0.25);
      border-color:rgba(255,255,255,0.2);
      transform:translateY(-2px);
    }
    .category-nav-btn{
      position:absolute; top:50%; transform:translateY(-50%); z-index:80;
      margin:0; padding:9.6px 18px; border:2px solid rgba(255,255,255,0.075); border-radius:15.6px;
      background:rgba(0,0,0,0.1125); backdrop-filter:blur(9.6px); box-shadow:none;
      color:#fff; font-weight:600; font-size:1.8rem; text-shadow:0 2.4px 9.6px rgba(0,0,0,0.8);
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
      transition:all 0.3s ease;
    }
    .category-nav-btn.prev{
      left:10px;
    }
    .category-nav-btn.next{
      right:10px;
    }
    .category-nav-btn:hover{
      background:rgba(0,0,0,0.1875);
      border-color:rgba(255,255,255,0.15);
      transform:translateY(-50%) scale(1.1);
    }
    .blink{
      animation:blink 1.2s ease-in-out infinite;
    }
    @keyframes blink{
      0%,100%{opacity:1}
      50%{opacity:0.35}
    }
    .shop-grid{
      flex:1; display:grid; grid-template-columns:repeat(4,1fr); grid-auto-rows:1fr;
      gap:6px; padding:10px; overflow-y:auto; width:100%; background:white;
    }
    .shop-card{
      background:#333; border-radius:8px; overflow:hidden; display:flex; flex-direction:column;
      align-items:center; text-align:center; color:white; font-size:0.75rem;
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }
    .shop-card:hover {
      transform: scale(1.05);
    }
    .shop-card .card-image-container {
      width: 100%;
      height: 70%;
      position: relative;
      overflow: hidden;
    }
    .shop-card img{ width:100%; height:100%; object-fit:cover; display:block; }
    .shop-card .shop-name{ padding:8px; flex:1; display:flex; align-items:center; }
    .card-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      font-size: 1rem;
      cursor: pointer;
      z-index: 20;
      display: block;
    }
    .card-nav-btn.prev {
      left: 4px;
    }
    .card-nav-btn.next {
      right: 4px;
    }
    .card-image-counter {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.6rem;
      z-index: 15;
    }
    .card-status-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      z-index: 15;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .card-status-badge.available {
      background: #22c55e;
    }
    .card-status-badge.booked {
      background: #f59e0b;
    }
    .card-status-badge.sold-out,
    .card-status-badge.rented {
      background: #ef4444;
    }
    .unit-price-overlay-card {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.65rem;
      color: white;
      line-height: 1.3;
      backdrop-filter: blur(5px);
      z-index: 10;
      text-align: left;
    }
    .unit-price-overlay-card .listing-type {
      font-weight: bold;
    }
    .unit-price-overlay-card .listing-type.for-sale {
      color: #ff4444;
    }
    .unit-price-overlay-card .listing-type.for-rent {
      color: #4488ff;
    }
    .unit-price-overlay-card .price {
      font-weight: bold;
    }
    .unit-price-overlay-card .price-sqm {
      font-size: 0.6rem;
    }
    .shop-card.empty{ background:#ddd; border:1px dashed #aaa; cursor:default; }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      font-size: 1rem;
      color: #666;
    }
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      font-size: 0.75rem;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .filter-select {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.6875rem;
      background: white;
      min-width: 80px;
      max-width: 120px;
      flex-shrink: 1;
    }
    .filter-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.625rem;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .filter-btn:hover {
      background: #0056b3;
    }
    .filter-label {
      font-size: 0.625rem;
      color: #666;
      margin-right: 4px;
      flex-shrink: 0;
      white-space: nowrap;
    }

    /* Blink animation */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Category text overlay */
    .category-text-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.0756);
      backdrop-filter: blur(8px);
      color: white;
      padding: 4.5px 0;
      overflow: hidden;
      z-index: 10;
      pointer-events: none;
      height: 30px;
      display: flex;
      align-items: center;
    }

    .category-text-overlay-content {
      display: inline-block;
      white-space: nowrap;
      animation: scroll-left-immediate 60s linear infinite;
      font-size: 1.0125rem;
      font-weight: 500;
      letter-spacing: 0.3375px;
      line-height: 1;
    }

    @keyframes scroll-left-immediate {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-100%);
      }
    }
  </style>
</head>
<body>
  <div class="page-wrapper" style="position: relative;">
    <div class="banner-container">
      <video id="bannerVideo" autoplay muted loop playsinline preload="none" style="display: none;">
        <source id="bannerSrc" src="" type="video/mp4" />
      </video>
      <div id="bannerText">DELIVERY</div>
      <div id="prevCategoryBtn" class="category-nav-btn prev blink">‚Äπ‚Äπ</div>
      <div id="nextCategoryBtn" class="category-nav-btn next blink">‚Ä∫‚Ä∫</div>
      <div id="backBtn" class="back-to-menu blink">Menu</div>
      <div class="category-text-overlay">
        <div class="category-text-overlay-content" id="categoryTextOverlay">
        </div>
      </div>
    </div>

    <!-- Cart icon removed -->

    <!-- Countdown overlay -->
    <div id="countdownOverlay" style="
      position: absolute;
      top: 10px;
      right: 10px;
      margin: 0;
      padding: 3px 7px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 7px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(4px);
      box-shadow: none;
      color: #fff;
      font-weight: 600;
      font-size: 0.5rem;
      letter-spacing: 0.1px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      white-space: nowrap;
      min-width: 35px;
      height: 20px;
      justify-content: center;
      z-index: 100;
      animation: blink 1.2s ease-in-out infinite;
      display: none;
    ">
      Back to Video in&nbsp;<span id="countdownSeconds">60</span>&nbsp;secs
    </div>

    <div class="filter-bar">
      <span class="filter-label">Filter:</span>
      <select id="categoryFilter" class="filter-select">
        <option value="">All Categories</option>
      </select>

      <span class="filter-label">Sort:</span>
      <select id="sortSelect" class="filter-select">
        <option value="name">Name A-Z</option>
        <option value="price-low">Price Low-High</option>
        <option value="price-high">Price High-Low</option>
      </select>

      <button id="clearFilters" class="filter-btn">Clear</button>
    </div>

    <div class="shop-grid" id="shopGrid">
      <div class="loading">Loading items...</div>
    </div>
  </div>

<script>
  console.log('=== SIMPLE CATEGORY PAGE STARTED ===');

  // Get parameters
  const qs = new URLSearchParams(location.search);
  const type = qs.get('type') || 'dining';

  console.log('Parameters:', { type });

  // Category navigation order (looping)
  const categoryOrder = ['dining', 'delivery', 'daily', 'ondemand', 'deal', 'juristic'];

  // Category text overlay content
  const categoryTexts = {
    'dining': '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Find nearby restaurants and reserve your table with ease.',
    'delivery': '‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏î‡∏±‡∏á‡∏ñ‡∏∂‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Order your favorite meals delivered straight to your room.',
    'daily': '‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ ‡∏¢‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Shop daily essentials, medicine, or flowers from nearby stores.',
    'ondemand': '‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏£‡πå ‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Request cleaning, repair, or home services on demand.',
    'deal': '‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Ç‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Buy, sell, or rent your unit easily within the project.',
    'juristic': '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp; Check the latest juristic updates and project announcements.'
  };

  // Set category text overlay
  const categoryTextOverlay = document.getElementById('categoryTextOverlay');
  categoryTextOverlay.innerHTML = categoryTexts[type] || '';

  function navigateCategory(direction) {
    const currentIndex = categoryOrder.indexOf(type);
    let newIndex = currentIndex + direction;

    // Loop around
    if (newIndex < 0) {
      newIndex = categoryOrder.length - 1;
    } else if (newIndex >= categoryOrder.length) {
      newIndex = 0;
    }

    const newType = categoryOrder[newIndex];
    console.log('Navigating to category:', newType);
    window.location.href = `./category.html?type=${newType}`;
  }

  // Setup category navigation buttons
  document.getElementById('prevCategoryBtn').onclick = function() {
    console.log('Previous category clicked');
    navigateCategory(-1);
  };

  document.getElementById('nextCategoryBtn').onclick = function() {
    console.log('Next category clicked');
    navigateCategory(1);
  };

  // Update banner text
  const bannerText = document.getElementById('bannerText');
  const titles = {
    'delivery': 'DELIVERY',
    'dining': 'DINING',
    'daily': 'DAILY SERVICES',
    'ondemand': 'ON-DEMAND',
    'deal': 'PROPERTY DEALS',
    'juristic': 'ANNOUNCEMENTS'
  };
  bannerText.textContent = titles[type] || type.toUpperCase();

  // Back button
  document.getElementById('backBtn').onclick = function() {
    console.log('Back button clicked');
    window.location.href = './menu.html';
  };

  // Load banner video
  const video = document.getElementById('bannerVideo');
  const videoSrc = document.getElementById('bannerSrc');
  videoSrc.src = `./corporate/medias/${type}.MP4`;

  video.onloadeddata = function() {
    console.log('Video loaded successfully');
    video.style.display = 'block';
    bannerText.style.display = 'none';
  };

  video.onerror = function() {
    console.log('Video failed to load, keeping text banner');
  };

  video.load();

  // Global variables for filtering
  let allItems = [];
  let filteredItems = [];

  // Update sort options based on page type
  function updateSortOptions() {
    const sortSelect = document.getElementById('sortSelect');

    // Clear existing options
    sortSelect.innerHTML = '';

    if (type === 'juristic') {
      // Sort options for announcements
      sortSelect.innerHTML = `
        <option value="name">Name A-Z</option>
        <option value="date-new">Date (Newest First)</option>
        <option value="date-old">Date (Oldest First)</option>
        <option value="priority">Priority (High to Low)</option>
      `;
    } else {
      // Default sort options for other types
      sortSelect.innerHTML = `
        <option value="name">Name A-Z</option>
        <option value="price-low">Price Low-High</option>
        <option value="price-high">Price High-Low</option>
      `;
    }
  }

  // Filter functionality
  function initializeFilters() {
    const categoryFilter = document.getElementById('categoryFilter');
    const sortSelect = document.getElementById('sortSelect');
    const clearFilters = document.getElementById('clearFilters');

    // Update sort options based on type
    updateSortOptions();

    // Populate category filter
    populateCategoryFilter();

    // Filter event listeners
    categoryFilter.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);

    // Clear filters
    clearFilters.addEventListener('click', function() {
      categoryFilter.value = '';
      sortSelect.value = 'name';
      applyFilters();
    });
  }

  function populateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    const categories = new Set();

    // Extract unique categories from items
    allItems.forEach(item => {
      if (item.category_th) categories.add(item.category_th);
      if (item.category_en) categories.add(item.category_en);
    });

    // Add categories to dropdown
    Array.from(categories).sort().forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });
  }

  function applyFilters() {
    const categoryValue = document.getElementById('categoryFilter').value;

    // Start with all items
    filteredItems = [...allItems];

    // Apply category filter
    if (categoryValue) {
      filteredItems = filteredItems.filter(item =>
        item.category_th === categoryValue || item.category_en === categoryValue
      );
    }

    // Apply sorting
    applySortAndRender();
  }

  function applySortAndRender() {
    const sortBy = document.getElementById('sortSelect').value;

    // Sort the filtered items
    switch(sortBy) {
      case 'name':
        filteredItems.sort((a, b) => {
          const nameA = (a.name_th || a.name_en || '').toLowerCase();
          const nameB = (b.name_th || b.name_en || '').toLowerCase();
          return nameA.localeCompare(nameB);
        });
        break;
      case 'price-low':
      case 'price-high':
        filteredItems.sort((a, b) => {
          const priceA = getItemPrice(a) || 0;
          const priceB = getItemPrice(b) || 0;
          return sortBy === 'price-low' ? priceA - priceB : priceB - priceA;
        });
        break;
      case 'date-new':
      case 'date-old':
        filteredItems.sort((a, b) => {
          const dateA = new Date(a.created_date || a.date || '2025-01-01');
          const dateB = new Date(b.created_date || b.date || '2025-01-01');
          return sortBy === 'date-new' ? dateB - dateA : dateA - dateB;
        });
        break;
      case 'priority':
        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        filteredItems.sort((a, b) => {
          const priorityA = priorityOrder[a.priority] || 2;
          const priorityB = priorityOrder[b.priority] || 2;
          return priorityB - priorityA; // High to low
        });
        break;
    }

    renderItems(filteredItems);
  }

  function getItemPrice(item) {
    if (item.price) return parseFloat(item.price) || 0;
    if (item.condition?.selling_price) return parseFloat(item.condition.selling_price) || 0;
    if (item.condition?.rental_price) return parseFloat(item.condition.rental_price) || 0;
    return 0;
  }

  // Load items
  async function loadItems() {
    const grid = document.getElementById('shopGrid');

    try {
      console.log('Loading items for type:', type);

      let items = [];

      if (type === 'delivery' || type === 'dining') {
        let restaurants = [];

        if (type === 'delivery') {
          const response = await fetch('./client/data/delivery.json');
          const data = await response.json();
          restaurants = data.delivery || data || [];
          console.log('Loaded delivery items:', restaurants.length);

          items = restaurants.filter(item =>
            true
          );

          // Transform delivery data to match expected structure
          items.forEach(item => {
            item.name_th = item.name_th || item.name || '';
            item.name_en = item.name_en || item.name || '';
            if (!item.images && item.image) {
              item.images = [item.image];
            }
            item.category_th = item.category_th || item.category || '';
            item.category_en = item.category_en || item.category || '';
          });
        } else {
          const response = await fetch('./client/data/dining.json');
          restaurants = await response.json();
          console.log('Loaded dining restaurants:', restaurants.length);

          items = restaurants.filter(item =>
            (item.type === 'dine' || item.type === 'both') &&
            item.status === 'active'
          );
        }
      }
      else if (type === 'daily' || type === 'ondemand') {
        let services = [];

        if (type === 'daily') {
          const response = await fetch('./client/data/daily.json');
          const data = await response.json();
          services = data.daily || data || [];
          console.log('Loaded daily items:', services.length);

          items = services.filter(item =>
            true
          );
        } else {
          const response = await fetch('./client/data/ondemand.json');
          const data = await response.json();
          services = data.ondemand || data || [];
          console.log('Loaded ondemand items:', services.length);

          items = services.filter(item =>
            true
          );
        }

        // Transform data to match expected structure
        items.forEach(item => {
          item.name_th = item.name_th || item.name || item.title || '';
          item.name_en = item.name_en || item.name || item.title || '';
          if (!item.images && item.image) {
            item.images = [item.image];
          }
        });
      }
      else if (type === 'deal') {
        const response = await fetch('./client/data/unit.json');
        const data = await response.json();
        console.log('Loaded units:', data.units.length);

        items = data.units.filter(item =>
          (item.condition?.selling_price || item.condition?.rental_price)
        );

        // Transform unit data
        items.forEach(unit => {
          const roomType = unit.unit?.room_type || 'Unit';
          const roomSize = unit.unit?.room_size ? ` ${unit.unit.room_size} sqm` : '';
          unit.name_th = `${roomType}${roomSize}`;
          unit.name_en = unit.name_th;
          unit.id = unit.unit_id;
        });
      }
      else if (type === 'juristic') {
        const response = await fetch('./project/data/announce.json');
        const announcements = await response.json();
        console.log('Loaded announcements:', announcements.length);

        items = announcements.filter(item =>
          item.status === 'active'
        );

        // Transform announcement data
        items.forEach(announcement => {
          announcement.name_th = announcement.title_th || announcement.title_en || '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®';
          announcement.name_en = announcement.title_en || announcement.title_th || 'Announcement';
          announcement.id = announcement.announcement_id;
          // Use announcement image as the card image
          announcement.images = announcement.image ? [announcement.image] : [];
        });
      }

      console.log('Filtered items:', items.length);
      console.log('Sample item:', items[0]);

      // Store items globally for filtering
      allItems = items;
      filteredItems = [...items];

      // Initialize filters
      initializeFilters();

      // Render initial items
      renderItems(filteredItems);

    } catch (error) {
      console.error('Error loading items:', error);
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: red;">Error loading items: ' + error.message + '</div>';
    }
  }

  // Render items function (separated for reuse by filters)
  function renderItems(items) {
    const grid = document.getElementById('shopGrid');

    // Clear grid
    grid.innerHTML = '';

    if (items.length === 0) {
      grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">No items found</div>';
      return;
    }

    let count = 0;

    // Render actual items
    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'shop-card';

        const name = item.name_th || item.name_en || item.id || 'Unknown';
        let imageSrc = './project/medias/placeholder.jpg';

        if (item.images && item.images.length > 0) {
          // Handle both absolute URLs (https://) and relative paths
          if (item.images[0].startsWith('http://') || item.images[0].startsWith('https://')) {
            imageSrc = item.images[0]; // Use absolute URL as-is
          } else if (item.images[0].startsWith('./')) {
            imageSrc = item.images[0]; // Already has relative path prefix
          } else {
            imageSrc = './' + item.images[0]; // Add relative path prefix
          }
        } else if (item.logo) {
          if (item.logo.startsWith('http://') || item.logo.startsWith('https://')) {
            imageSrc = item.logo; // Use absolute URL as-is
          } else if (item.logo.startsWith('./')) {
            imageSrc = item.logo; // Already has relative path prefix
          } else {
            imageSrc = './' + item.logo; // Add relative path prefix
          }
        }

        // Build price overlay for units
        let priceOverlay = '';
        if (type === 'deal' && item.unit && item.condition) {
          const listingType = item.unit.listing_type || (item.condition.selling_price ? 'Sell' : 'Rent');
          const price = item.condition.selling_price || item.condition.rental_price;
          const roomSize = item.unit.room_size;
          const pricePerSqm = roomSize ? Math.round(price / roomSize) : 0;
          const listingClass = listingType.toLowerCase() === 'sell' ? 'for-sale' : 'for-rent';

          priceOverlay = `
            <div class="unit-price-overlay-card">
              <div class="listing-type ${listingClass}">For ${listingType}</div>
              <div class="price">‡∏ø${price.toLocaleString()}</div>
              ${pricePerSqm ? `<div class="price-sqm">‡∏ø${pricePerSqm.toLocaleString()}/sqm</div>` : ''}
            </div>
          `;
        }

        // Build image HTML with navigation if multiple images exist
        const hasMultipleImages = item.images && item.images.length > 1;
        let imageHTML = '';

        // Get status badge HTML
        const status = item.unit?.status || '';
        const statusClass = status.toLowerCase().replace(/\s+/g, '-');
        const statusBadge = status ? `<div class="card-status-badge ${statusClass}">${status}</div>` : '';

        if (hasMultipleImages) {
          imageHTML = `
            <div class="card-image-container">
              <img class="card-main-image" src="${imageSrc}" alt="${name}" onerror="this.src='./project/medias/placeholder.jpg'">
              ${priceOverlay}
              ${statusBadge}
              <button class="card-nav-btn prev" onclick="event.stopPropagation(); navigateCardImage(this, -1)">‚Äπ</button>
              <button class="card-nav-btn next" onclick="event.stopPropagation(); navigateCardImage(this, 1)">‚Ä∫</button>
              <div class="card-image-counter"><span class="current-img">1</span>/<span class="total-img">${item.images.length}</span></div>
            </div>
          `;
        } else {
          imageHTML = `
            <div class="card-image-container">
              <img src="${imageSrc}" alt="${name}" onerror="this.src='./project/medias/placeholder.jpg'">
              ${priceOverlay}
              ${statusBadge}
            </div>
          `;
        }

        div.innerHTML = `
          ${imageHTML}
          <div class="shop-name">${name}</div>
        `;

        // Store images data on the card for navigation
        if (hasMultipleImages) {
          div.dataset.images = JSON.stringify(item.images);
          div.dataset.currentIndex = '0';
        }

        // Add click handler
        div.onclick = function() {
          console.log('Item clicked:', item.id);

          if (type === 'daily') {
            window.location.href = `./product.html?type=daily&id=${item.id}`;
          } else if (type === 'ondemand') {
            window.location.href = `./product.html?type=ondemand&id=${item.id}`;
          } else if (type === 'delivery') {
            window.location.href = `./product.html?type=delivery&id=${item.id}`;
          } else if (type === 'dining') {
            window.location.href = `./product.html?type=restaurant&id=${item.id}`;
          } else if (type === 'deal') {
            window.location.href = `./product.html?type=unit&id=${item.id}`;
          } else if (type === 'juristic') {
            openAnnouncementPopup(item);
          }
        };

        grid.appendChild(div);
        count++;
      });

    // Fill empty spaces to always have 12 slots (4x3 grid)
    for (let i = count; i < 12; i++) {
      const div = document.createElement('div');
      div.className = 'shop-card empty';
      grid.appendChild(div);
    }
  }

  // Cart functionality removed

  // Load items immediately
  loadItems();

  // Cart display removed

  // Auto-return to main menu after 60 seconds of inactivity
  let inactivityTimer;
  let countdownInterval;
  let countdownStartTime;
  const RETURN_DELAY = 60000; // 60 seconds
  const COUNTDOWN_SHOW_DELAY = 10000; // Show countdown after 10 seconds

  function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    clearInterval(countdownInterval);
    document.getElementById('countdownOverlay').style.display = 'none';

    countdownStartTime = Date.now();

    inactivityTimer = setTimeout(() => {
      // Return to main menu, not signage
      window.location.href = './menu.html';
    }, RETURN_DELAY);

    // Show countdown after 10 seconds
    setTimeout(() => {
      showCountdown();
    }, COUNTDOWN_SHOW_DELAY);
  }

  function showCountdown() {
    const overlay = document.getElementById('countdownOverlay');
    const secondsSpan = document.getElementById('countdownSeconds');

    overlay.style.display = 'flex';

    countdownInterval = setInterval(() => {
      const elapsed = Date.now() - countdownStartTime;
      const remaining = Math.max(0, Math.ceil((RETURN_DELAY - elapsed) / 1000));

      secondsSpan.textContent = remaining;

      if (remaining <= 0) {
        clearInterval(countdownInterval);
        overlay.style.display = 'none';
      }
    }, 1000);
  }

  // Set up inactivity listeners
  ['click', 'touchstart', 'mousemove', 'keydown'].forEach(event => {
    document.addEventListener(event, resetInactivityTimer);
  });

  // Start the timer
  resetInactivityTimer();

  // Get image source (same logic as category cards)
  function getImageSrc(item) {
    let imageSrc = './project/medias/placeholder.jpg';

    if (item.images && item.images.length > 0) {
      // Handle both absolute URLs (https://) and relative paths
      if (item.images[0].startsWith('http://') || item.images[0].startsWith('https://')) {
        imageSrc = item.images[0]; // Use absolute URL as-is
      } else {
        imageSrc = './' + item.images[0]; // Add relative path prefix
      }
    } else if (item.logo) {
      if (item.logo.startsWith('http://') || item.logo.startsWith('https://')) {
        imageSrc = item.logo; // Use absolute URL as-is
      } else {
        imageSrc = './' + item.logo; // Add relative path prefix
      }
    }

    return imageSrc;
  }

  // Announcement popup function
  function openAnnouncementPopup(item) {
    const popup = document.createElement('div');
    popup.id = 'announcementPopup';
    popup.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    `;

    const countdownTime = 15; // 15 seconds
    let timeLeft = countdownTime;

    popup.innerHTML = `
      <div style="
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
      ">
        <img src="${getImageSrc(item)}"
             style="
               max-width: 100%;
               max-height: 80vh;
               object-fit: contain;
               border-radius: 8px;
               box-shadow: 0 4px 20px rgba(0,0,0,0.5);
             "
             onerror="this.src='./project/medias/placeholder.jpg'">
        <div id="countdownText" style="
          color: white;
          font-size: 1.5rem;
          font-weight: 600;
          margin-top: 20px;
          text-align: center;
          background: rgba(0,0,0,0.7);
          padding: 10px 20px;
          border-radius: 20px;
        ">
          Auto close in ${timeLeft}s
        </div>
        <button onclick="closeAnnouncementPopup()" style="
          position: absolute;
          top: -10px;
          right: -10px;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: white;
          border: none;
          font-size: 1.25rem;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        ">√ó</button>
      </div>
    `;

    document.body.appendChild(popup);

    // Countdown timer
    const countdownInterval = setInterval(() => {
      timeLeft--;
      const countdownEl = document.getElementById('countdownText');
      if (countdownEl) {
        countdownEl.textContent = `Auto close in ${timeLeft}s`;
      }
      if (timeLeft <= 0) {
        clearInterval(countdownInterval);
        closeAnnouncementPopup();
      }
    }, 1000);

    // Store interval for cleanup
    popup.countdownInterval = countdownInterval;

    // Reset inactivity timer
    resetInactivityTimer();
  }

  // Close popup function
  window.closeAnnouncementPopup = function() {
    const popup = document.getElementById('announcementPopup');
    if (popup) {
      if (popup.countdownInterval) {
        clearInterval(popup.countdownInterval);
      }
      popup.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => popup.remove(), 300);
    }
    resetInactivityTimer();
  };

  // Add fade animations
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
  `;
  document.head.appendChild(style);

  // Card image navigation function
  function navigateCardImage(button, direction) {
    const card = button.closest('.shop-card');
    const images = JSON.parse(card.dataset.images);
    let currentIndex = parseInt(card.dataset.currentIndex);

    // Calculate new index
    currentIndex += direction;
    if (currentIndex < 0) currentIndex = images.length - 1;
    if (currentIndex >= images.length) currentIndex = 0;

    // Update the image
    const imgElement = card.querySelector('.card-main-image');
    let newImageSrc;
    if (images[currentIndex].startsWith('http://') || images[currentIndex].startsWith('https://')) {
      newImageSrc = images[currentIndex];
    } else if (images[currentIndex].startsWith('./')) {
      newImageSrc = images[currentIndex];
    } else {
      newImageSrc = './' + images[currentIndex];
    }

    imgElement.src = newImageSrc;

    // Update counter
    card.querySelector('.current-img').textContent = currentIndex + 1;

    // Store new index
    card.dataset.currentIndex = currentIndex;
  }

  console.log('=== SCRIPT LOADED SUCCESSFULLY ===');

  // Register Service Worker for media caching
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registered successfully:', registration.scope);
        return navigator.serviceWorker.ready;
      })
      .then(() => {
        console.log('‚úÖ Service Worker is ready');
        preloadMediaFiles();
      })
      .catch((error) => {
        console.error('‚ùå Service Worker registration failed:', error);
      });

    // Listen for download progress messages from Service Worker
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data.action === 'downloadProgress') {
        const { current, total } = event.data;
        const percent = Math.round((current / total) * 100);
        console.log(`üì• Downloading media: ${current}/${total} (${percent}%)`);
      }

      if (event.data.action === 'downloadComplete') {
        const { downloaded, total } = event.data;
        console.log(`‚úÖ All media files stored on device: ${downloaded}/${total}`);
      }
    });
  } else {
    console.warn('‚ö†Ô∏è Service Worker not supported in this browser');
  }

  // Helper function to load JSON
  async function loadJson(url) {
    const response = await fetch(url, { cache: 'no-store' });
    return await response.json();
  }

  // Preload ALL media files (videos and images) for instant playback
  async function preloadMediaFiles(){
    if ('serviceWorker' in navigator) {
      try {
        const registration = await navigator.serviceWorker.ready;

        if (!navigator.serviceWorker.controller) {
          console.log('‚è≥ Service Worker not controlling yet, waiting...');
          return;
        }

        // Collect ALL media files (videos and images)
        let allMediaUrls = [];

        // 1. Load images from dining.json
        try {
          const diningData = await loadJson('./client/data/dining.json');
          if (diningData && Array.isArray(diningData)) {
            let diningCount = 0;
            diningData.forEach(rest => {
              if (rest.logo) { allMediaUrls.push(rest.logo); diningCount++; }
              if (rest.images) { allMediaUrls.push(...rest.images); diningCount += rest.images.length; }
              if (rest.menu && Array.isArray(rest.menu)) {
                rest.menu.forEach(item => {
                  if (item.image) { allMediaUrls.push(item.image); diningCount++; }
                });
              }
            });
            console.log('üì¶ Found', diningCount, 'dining images');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Could not load dining images:', error);
        }

        // 2. Load images from ondemand.json
        try {
          const ondemandData = await loadJson('./client/data/ondemand.json');
          if (ondemandData && ondemandData.ondemand) {
            let ondemandCount = 0;
            ondemandData.ondemand.forEach(od => {
              if (od.logo) { allMediaUrls.push(od.logo); ondemandCount++; }
              if (od.images) { allMediaUrls.push(...od.images); ondemandCount += od.images.length; }
            });
            console.log('üì¶ Found', ondemandCount, 'ondemand images');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Could not load ondemand images:', error);
        }

        // 3. Load images from unit.json
        try {
          const unitData = await loadJson('./client/data/unit.json');
          if (unitData && unitData.units) {
            let unitCount = 0;
            unitData.units.forEach(unit => {
              if (unit.images) { allMediaUrls.push(...unit.images); unitCount += unit.images.length; }
              if (unit.floor_plan) { allMediaUrls.push(unit.floor_plan); unitCount++; }
            });
            console.log('üì¶ Found', unitCount, 'unit images');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Could not load unit images:', error);
        }

        // Remove duplicates and filter out empty/null values
        allMediaUrls = [...new Set(allMediaUrls.filter(url => url && url.trim()))];

        if (allMediaUrls.length > 0) {
          console.log('üì¶ Requesting preload of', allMediaUrls.length, 'total media files (videos + images) via Service Worker...');

          navigator.serviceWorker.controller.postMessage({
            action: 'preloadMedia',
            urls: allMediaUrls
          });
        } else {
          console.warn('‚ö†Ô∏è No media files found to preload');
        }
      } catch (error) {
        console.error('‚ùå Service Worker preload failed:', error);
      }
    }
  }
</script>
</body>
</html>